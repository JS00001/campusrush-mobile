name: Deploy (Staging)

on:
  push:
    branches:
      - staging
    paths:
      - "package.json"
      - "app.config.js"
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Run only if package.json or app.config.js changed OR if it's a scheduled build
        run: |
          if [[ -n $(git diff HEAD^ HEAD --name-only | grep 'package.json') ]]; then
            echo "package.json changed"
          else
            last_push_date=$(git log -1 --pretty=format:'%ct')
            current_date=$(date +%s)
            if (( current_date - last_push_date < 86400 )); then
              echo "Within 24 hours since last push"
            else
              echo "No action needed"
              exit 0
            fi
          fi

      - name: Check for STAGING_EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.STAGING_EXPO_TOKEN }}" ]; then
            echo "You must provide an STAGING_EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: yarn

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.STAGING_EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install

      - name: Publish update
        run: eas update --auto

        # Report status to slack channel via webhook
      - name: âœ… Report Status
        if: always()
        uses: ravsamhq/notify-slack-action@v1
        with:
          icon_success: ":white_check_mark:"
          icon_failure: ":x:"
          token: ${{secrets.GITHUB_TOKEN}}
          status: ${{ job.status }}
          notification_title: ""
          message_format: "{emoji} *{workflow}* {status_message} in <{repo_url}|{repo}>\n\n*Commit URL:* <${{github.event.head_commit.url}}|${{github.event.head_commit.id}}>\n*Commit Message:* ${{github.event.head_commit.message}}\n*Commit Author:* <https://github.com/${{github.event.head_commit.author.name}}|${{github.event.head_commit.author.name}}>\n*Build URL:* <${{github.event.repository.url}}/actions/runs/${{github.run_id}}|${{github.run_id}}>"
          footer: "Linked Repo <{repo_url}|{repo}>"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_STAGING }}
